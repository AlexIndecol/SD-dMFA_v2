%% Detailed full-chain scope of dMFA + SD coupling
%% Derived from configs/coupling.yml and configs/dimensions.yml

flowchart LR
  subgraph EXO[Exogenous Inputs]
    EXO_DEMAND[demand_kt_per_yr]
    EXO_COLL[collection_rate_0_1]
    EXO_REC[recovery_rate_0_1]
    EXO_YIELD[recycling_yield_0_1]
    EXO_LIFE[lifetime_multiplier_ge_1]
    EXO_CAP[capacity_stage_raw_kt_per_yr]
    EXO_PRICE[price_index_rel optional]
    EXO_ODW[od_preference_weight_0_1]
    EXO_TF[trade_factor_i_ge_1]
  end

  subgraph SD[SD Model annual dynamics]
    SD_DEM[Demand and policy state]
    SD_SCAR[Scarcity and price perception]
    SD_LEV[Levers collection recovery capacity lifetime]
  end

  subgraph DMFA[dMFA full chain]
    P1[primary_extraction]
    P2[beneficiation_concentration]
    P3[refining_primary]
    P4[fabrication_and_manufacturing]
    P5[use_phase and in_use_stock]
    P6[collection]
    P7[sorting_preprocessing]
    P8[recycling_refining_secondary]
    P9[residue_treatment_disposal]
    P10[environment]
  end

  subgraph STAB[Coupling stabilizer]
    STAB_SEC[s_sec_max_to_sd_kt_per_yr]
    STAB_CAP[capacity_stage_to_sd_kt_per_yr]
    STAB_EXP[od_export_cap_kt_per_yr]
    STAB_PRICE[price_to_sd_smoothed_rel optional]
  end

  subgraph TRADE[OD Trade allocator]
    TR_IN[OD weights frictions export caps]
    TR_ALLOC[Allocate OD flows by commodity]
    TR_OUT[imports exports share_i_frac]
  end

  subgraph IND[Indicators]
    IND1[supply concentration]
    IND2[circularity and recycling]
    IND3[demand fulfilment]
    IND4[buffers losses and stocks]
  end

  P1 --> P2 --> P3 --> P4 --> P5 --> P6 --> P7
  P7 --> P8 --> P4
  P7 --> P9 --> P10

  EXO_DEMAND --> SD_DEM
  EXO_COLL --> SD_LEV
  EXO_REC --> SD_LEV
  EXO_YIELD --> SD_LEV
  EXO_LIFE --> SD_LEV
  EXO_CAP --> SD_LEV
  EXO_PRICE --> SD_SCAR
  EXO_ODW --> TR_IN
  EXO_TF --> TR_IN

  SD_DEM --> SD_SCAR
  SD_SCAR --> SD_LEV
  SD_LEV --> SD_DEM

  SD_DEM -->|sd_to_dmfa demand_kt_per_yr| P4
  SD_LEV -->|collection and recovery rates| P6
  SD_LEV -->|recycling_yield_0_1| P8
  SD_LEV -->|lifetime_multiplier_ge_1| P5
  SD_LEV -->|capacity_stage_raw_kt_per_yr| P1
  SD_SCAR -->|price_index_rel optional| P4

  P7 -->|s_sec_max_raw_kt_per_yr| STAB_SEC
  P1 -->|capacity signals| STAB_CAP
  P2 -->|capacity signals| STAB_CAP
  P3 -->|capacity signals| STAB_CAP
  SD_SCAR -->|price smoothing input| STAB_PRICE

  STAB_SEC --> SD_SCAR
  STAB_CAP --> SD_LEV
  STAB_CAP --> STAB_EXP
  STAB_EXP --> TR_IN
  STAB_PRICE --> SD_SCAR

  P2 -->|export concentrate availability| TR_IN
  P3 -->|export refined availability| TR_IN
  P7 -->|export scrap availability| TR_IN
  TR_IN --> TR_ALLOC --> TR_OUT

  TR_OUT -->|imports concentrate| P3
  TR_OUT -->|imports refined_metal| P4
  TR_OUT -->|imports scrap| P8
  TR_OUT -->|trade_outputs to SD| SD_SCAR

  P10 -->|total_losses_kt_per_yr| SD_SCAR
  P5 -->|in_use_stock_kt| SD_SCAR
  P6 -->|eol_outflow_kt_per_yr| SD_SCAR
  P4 -->|i_use_kt_per_yr unmet_demand_kt_per_yr| SD_DEM
  P3 -->|stock_refined_metal_kt| SD_SCAR
  P7 -->|stock_scrap_kt| SD_SCAR
  P2 -->|stock_concentrate_kt| SD_SCAR

  SD_DEM --> IND3
  SD_SCAR --> IND4
  P5 --> IND2
  P7 --> IND2
  TR_OUT --> IND1
  P10 --> IND4
